<!DOCTYPE html>
<html>
    <!-- D3 library -->
    <script src='https://d3js.org/d3.v5.min.js'></script>
    <!-- D3 Annotations library -->
    <script src="https://rawgit.com/susielu/d3-annotation/master/d3-annotation.min.js"></script>

    <!-- Helpers -->
    <script>
        // Helper to call something on end of all transitions from https://stackoverflow.com/questions/10692100/invoke-a-callback-at-the-end-of-a-transition/20773846#20773846
        function endall(transition, callback) { 
            if (typeof callback !== "function") throw new Error("Wrong callback in endall");
            if (transition.size() === 0) { callback() }
            var n = 0; 
            transition 
                .each(function() { ++n; }) 
                .each("end", function() { if (!--n) callback.apply(this, arguments); }); 
        } 

        function getFile(path){
            const baseUrl = "https://raw.githubusercontent.com/ckeenan34/ckeenan34.github.io/main/";
            return baseUrl + path;
        }
        function countUnique(arr, prop="name"){
            return uniqueByProp(arr, prop).length;
        }
        function uniqueByProp(arr, prop="name"){
            return Array.from(new Set(Array.from(arr).map(v=> v[prop])))
        }
        function filterByProps(data, mapping={}){
            var newData = data;
            Object.keys(mapping).forEach(prop => {
                newData = newData.filter(d => d[prop] == mapping[prop]);
            });
            return newData;
        }
        function sortByProp(data, prop){
            data.sort((a,b)=> d3.descending(+a[prop], +b[prop]));
            return data;
        }
        // ordinal function credited to https://stackoverflow.com/questions/13627308/add-st-nd-rd-and-th-ordinal-suffix-to-a-number/57518703#57518703
        function ordinal(number) {
            const english_ordinal_rules = new Intl.PluralRules("en", {
                type: "ordinal"
            });
            const suffixes = {
                one: "st",
                two: "nd",
                few: "rd",
                other: "th"
            }
            const suffix = suffixes[english_ordinal_rules.select(number)];
            return (number + suffix);
        }
        // times a number by a billion. Helpful since the data comes in divided by a billion
        function tb(num){
            return num*1000000000;
        }

        // setting up a global variable for saving parameters and caching data
        let props = {
            originalData: undefined,
            data: undefined
        }
        const slides = [
            {
                xAxis: "wealth.worth in billions",
                yAxis: "name",
                colorBy: "location.citizenship",
                filters: {
                    year: "2001"
                },
                slide: 1
            },
            {
                xAxis: "wealth.per.gdp",
                yAxis: "name",
                colorBy: "location.citizenship",
                filters: {
                    year: "2001"
                },
                slide: 2
            },
            {
                xAxis: "wealth.per.age",
                yAxis: "name",
                colorBy: "location.citizenship",
                filters: {
                    year: "2014"
                },
                slide: 3
            },
        ]
        // start with slide 1 properties
        function switchToSlide(slide){
            slide = Math.floor(slide);
            if (slide >= slides.length || slide < 0){
                console.warn("Invalid slide: "+ slide);
                return false;
            }
            Object.assign(props, slides[slide-1]);
            return true;
        }
    </script>

    <style>
        .tooltip {
            position: absolute;
            z-index: 100;
            display: block;
        }
    </style>

    <!-- Main D3 visualizations -->
    <script>
        // forced to wrap this in async function so we can use await
        (async()=>{
            // start on slide 1
            switchToSlide(1);

            // fetch the data and stitch 
            let data = await d3.csv(getFile("/data/billionaires.csv"));
            data.forEach(d => {
                debugger;
                d['wealth.per.gdp'] = !(denom = +d["location.gdp"]) || denom===0 ? 0: tb(+d["wealth.worth in billions"])/denom;
                d['wealth.per.age'] = !(denom = +d["demographics.age"]) || denom ? 0: tb(+d["wealth.worth in billions"])/denom;
            });
            props.originalData = data;

            // setup the default props
            props.data = filterByProps(props.originalData, props.filters);
            props.data = sortByProp(props.data, props.xAxis);
            console.log(props.data);

            var countUniqueNames = countUnique(props.data);

            // Credit to https://d3-graph-gallery.com/graph/barplot_horizontal.html for getting me started on a horizontal bar chart
            // I've modified this quite a bit, 
            // set the dimensions and margins of the graph
            var margin = {top: 80, right: 30, bottom: 40, left: 200},
                width = 1500 - margin.left - margin.right,
                height = 20*countUniqueNames - margin.top - margin.bottom;

            // append the svg object to the body of the page
            var svg = d3.select("#svg1")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                    .attr("transform",
                        "translate(" + margin.left + "," + margin.top + ")");

            // Add X axis
            var x = d3.scaleLinear()
                .domain([0, 1.1*d3.max(props.data, (d)=> +d[props.xAxis])])
                .range([0, width]);
            var xAxis = d3.axisTop(x);

            svg.append("text")
                .attr("class", "xAxisTitle")
                .attr("text-anchor", "middle")
                .attr("x", width/2)
                .attr("y", -margin.top/2)
                .text("Wealth in Billions (USD)");
            svg.append("g")
                .attr("class", "xaxis")
                .transition().duration(0)
                .call(xAxis);

            // Y axis
            var y = d3.scaleBand()
                .range([ 0, height ])
                .domain(props.data.map(function(d) { return d.name; }))
                .padding(.1);

            var yAxis = d3.axisLeft(y);
            svg.append("g")
                .attr("class", "yaxis")
                .transition().duration(0)
                .call(yAxis)

            var colorScale = d3.scaleOrdinal()
                .domain(uniqueByProp(props.data, props.colorBy))
                .range(d3.schemeCategory10);

            // Setup tooltip. Modified from this helpful page https://d3-graph-gallery.com/graph/interactivity_tooltip.html
            var Tooltip = d3.select("#chart")
                .append("div")
                .attr("class", "tooltip")
                .style("opacity", 0)
                .style("background-color", "white")
                .style("border", "solid")
                .style("border-width", "2px")
                .style("border-radius", "5px")
                .style("padding", "5px")

            // Three function that change the tooltip when user hover / move / leave a cell
            var mouseover = function(d) {
                Tooltip
                .style("opacity", 1)
                .html("This billionaire is worth: $" + tb(d["wealth.worth in billions"]).toLocaleString())
                .style("left", (x(d[props.xAxis])+margin.left+10) + "px")
                .style("top", (y(d.name)+margin.top) + "px")
                d3.select(this)
                .style("stroke", "black")
                .style("opacity", 1)
            }
            var mouseleave = function(d) {
                Tooltip
                .style("opacity", 0)
                d3.select(this)
                .style("stroke", "none")
                .style("opacity", 0.9)
            }
            
            //Bars
            svg.selectAll("rect")
                .data(props.data)
                .enter()
                .append("rect")
                    .attr("y", function(d) { return y(d[props.yAxis]); })
                    .attr("height", y.bandwidth())
                    .on("click", (d)=> window.open("https://www.google.com/search?q=" + encodeURIComponent(d.name), "_blank"))
                    .on("mouseover", mouseover)
                    .on("mouseleave", mouseleave)
                .transition().duration(1000)
                    .attr("x", x(0))
                    .attr("y", function(d) { return y(d[props.yAxis]); })
                    .attr("width", function(d) { return x(d[props.xAxis]); })
                    .attr("height", y.bandwidth())
                    .attr("fill", (d) => colorScale(d[props.colorBy]))
                    .style("opacity", 0.9)
                    .end()
                    .then(addSlideAnnotations) // add the annotations (see below for all annotation functions)

            // annotations
            function annotationLocation(selector, rectContactLoc=1){
                var row;
                if (typeof(selector) == "string"){
                    row = props.data.find(d => d.name === selector);
                }else if (typeof(selector) == 'number'){
                    row = props.data?.[selector];
                }
                if (!row){
                    // if this is invalid, return a point that doesn't show up on the chart
                    return {x: -10000, y: -10000}
                }
                return {
                    x: x(row[props.xAxis]) + margin.left,
                    y: y(row[props.yAxis]) + margin.top + y.bandwidth() * rectContactLoc
                }
            }
            function topNAnnotation(n, percent){
                if (percent){
                    n = Math.floor(props.data.length*percent+.5);
                }
                var total = d3.sum(props.data.slice(0, n).map(o=>o[props.xAxis]))
                total *= 1000000000;
                total = Math.floor(total + .5);
                return {
                    note: {
                        label: `The ${n} people above this line have a combined total of \$${total.toLocaleString()}`,
                        title: "",
                        wrap: 190
                    },
                    dy: 0,
                    dx: 100,
                    color: ["black"],
                    ...annotationLocation(n-1, 1)
                }
            }
            function selectAnnotations(slide){
                const annotations = [
                    {
                        note: {
                            label: "Bill Gates held the #1 spot for 18 years (non-continuous) and was overtaken by Jeff Bezos in 2017.",
                            title: "Richest man in the world (at the time)",
                            wrap: 190,
                        },
                        dy: 100,
                        dx: -100,
                        color: ["black"],
                        ...annotationLocation("Bill Gates"),
                        slides: new Set([1])
                    },
                    {
                        note: {
                            label: "These are brothers who inherited their dad's company",
                            title: "",
                            wrap: 190,
                        },
                        dy: -50,
                        dx: 100,
                        color: ["black"],
                        ...annotationLocation("Thomas and Raymond Kwok", .5),
                        slides: new Set([1])
                    },
                    {
                        note: {
                            label: "The dad created FEMSA, primarily known for bottling Coca Cola in Mexico",
                            title: "Two more brothers who inherited their dad's company",
                            wrap: 190,
                        },
                        dy: -50,
                        dx: 100,
                        color: ["black"],
                        ...annotationLocation("Jose and Francisco Jose Calderon Rojas", .5),
                        slides: new Set([1])
                    },
                    {
                        note: {
                            label: "Thank you Tom for contributing to UIUC and for funding my master's program through C3 AI",
                            title: "",
                            wrap: 190,
                        },
                        dy: -50,
                        dx: 100,
                        color: ["black"],
                        ...annotationLocation("Thomas Siebel", .5),
                        slides: new Set([1])
                    },
                    {...topNAnnotation(20), slides: new Set([1, 2])},
                    {...topNAnnotation(200), slides: new Set([1, 2])},
                    {...topNAnnotation(null, .5), slides: new Set([1, 2])},
                    {...topNAnnotation(null, .9), slides: new Set([1, 2])},
                    {
                        note: {
                            label: `Even the ${ordinal(props.data.length)} person here has \$${tb(props.data[props.data.length -1]["wealth.worth in billions"]).toLocaleString()}!`,
                            title: "",
                            wrap: 190,
                        },
                        dy: -100,
                        dx: 100,
                        color: ["black"],
                        ...annotationLocation(props.data.length - 1, 0),
                        slides: new Set([1,2])
                    }
                ]
                return annotations.filter((ann) => ann.slides.has(slide));
            }
            function addSlideAnnotations(){
                // remove old annotations if they are still there
                d3.select('#svg1 > g.annotations').remove();
                d3.select("#svg1")
                    .append("g")
                    .attr("class", "annotations")
                    .call(d3.annotation().annotations(selectAnnotations(props.slide)))
            }

            function transition(){
                // sort/filter the underlying data according to the props
                props.data = filterByProps(props.originalData, props.filters);
                props.data = sortByProp(props.data, props.xAxis);
                console.log(props);

                // change variables in preparation for transition
                // svg height needs to change because it depends on the number of billionaires
                
                var countUniqueNames = countUnique(props.data);
                height = 20*countUniqueNames - margin.top - margin.bottom;
                // axes
                x.domain([0, 1.1*d3.max(props.data, (d)=> +d[props.xAxis])]);
                y.domain(props.data.map((d) => d[props.yAxis])).range([0,height]);
                // color
                colorScale.domain(uniqueByProp(props.data, props.colorBy));

                debugger;
                // remove annotations
                d3.select('#svg1 > g.annotations').remove();

                // change the height on the svg
                d3.select("#svg1")
                    .attr("height", height + margin.top + margin.bottom)

                // add the data to the rects
                var mark = svg.selectAll("rect")
                    .data(props.data)
                
                // add all new data
                mark.enter().append("rect");

                // move all rects
                mark.transition().duration(1000)
                    .attr("x", x(0))
                    .attr("y", function(d) { return y(d[props.yAxis]); })
                    .attr("width", function(d) { return x(d[props.xAxis]); })
                    .attr("height", y.bandwidth())
                    .attr("fill", (d) => colorScale(d[props.colorBy]))
                    .style("opacity", 0.9)
                    .end()
                    .then(addSlideAnnotations)
                
                // remove rects that are no longer in the data
                mark.exit()
                    .transition()
                    .remove()

                // transition axes
                svg.select(".xaxis")
                    .transition().duration(1000)
                    .call(xAxis);
                svg.select(".yaxis")
                    .transition().duration(1000)
                    .call(yAxis)

                return true;
            }
            
            function nextSlide(){
                props.slide++;
                return switchToSlide(props.slide) && transition();
            }
            // let autoNextSlide = setTimeout(()=> {
            //     console.log("auto next slide");
            //     nextSlide();
            //     // if (!nextSlide()){
            //     //     clearInterval(autoNextSlide);
            //     // }
            // }, 5000)
        })()
    </script>

    <body>
      <h1>UIUC CS 415 - Narrative Visualization (in progress)</h1>
      <h2>By Cameron Keenan</h2>
      <div id="chart" style="position:relative">
        <svg id="svg1"></svg>
      </div>

    </body>
</html>